<%- include('_header', { title: 'Keranjang Belanja' }) %>

<h1 class="reveal-on-scroll">Keranjang Belanja Anda</h1>

<% if (cart.length > 0) { %>
    <div class="card reveal-on-scroll">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Produk</th>
                        <th>Harga</th>
                        <th>Jumlah</th>
                        <th>Subtotal</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <% cart.forEach(item => { %>
                        <tr>
                            <td><%= item.name %></td>
                            <td>Rp <%= Number(item.price).toLocaleString('id-ID') %></td>
                            <td><%= item.quantity %></td>
                            <td>Rp <%= Number(item.price * item.quantity).toLocaleString('id-ID') %></td>
                            <td>
                                <a href="/cart/remove/<%= item.id %>" class="btn btn-danger btn-sm">Hapus</a>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>

    <div class="row mt-4 justify-content-end reveal-on-scroll">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">Total Belanja:</h3>
                    <h2 class="text-danger">Rp <%= Number(total).toLocaleString('id-ID') %></h2>
                    <hr>
                    
                    <div class="d-grid">
                        <button id="checkout-button" class="btn btn-success btn-lg">
                            Bayar dengan Kartu (Visa)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<% } else { %>
    <div class="alert alert-info mt-4 reveal-on-scroll" role="alert">
        Keranjang Anda masih kosong. <a href="/" class="alert-link">Mulai belanja</a>!
    </div>
<% } %>


<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripePublicKey = '<%= locals.stripePublicKey %>';
    const stripe = Stripe(stripePublicKey);
    const checkoutButton = document.getElementById('checkout-button');

    // [PERBAIKAN] Tambahkan 'if' agar tidak error jika admin mengunjungi halaman ini
    if (checkoutButton) {
        checkoutButton.addEventListener('click', function() {
            checkoutButton.disabled = true;
            checkoutButton.innerHTML = 'Memproses...';

            fetch('/create-checkout-session', {
                method: 'POST',
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(session) {
                if (session.id) {
                    return stripe.redirectToCheckout({ sessionId: session.id });
                } else {
                    alert(session.error || 'Terjadi kesalahan.');
                    checkoutButton.disabled = false;
                    checkoutButton.innerHTML = 'Bayar dengan Kartu (Visa)';
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                checkoutButton.disabled = false;
                checkoutButton.innerHTML = 'Bayar dengan Kartu (Visa)';
            });
        });
    }
</script>

<%- include('_footer') %>